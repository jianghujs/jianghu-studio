{% block htmlHead %}
<style>
  /* css */
</style>
{% endblock %}

{% extends 'template/jhsTemplate.html'%}
{% block vueTemplate %}
<script type="text/html" id="app-template">
  <div>
    <v-app mobile-breakpoint="sm">
      <v-main>
        <!-- 头部内容 >>>>>>>>>>>>> -->
        <div class="px-8 py-0 mt-4 designPageHead">
          <v-card class="rounded-lg d-flex" style="align-items: center;">
            <v-bottom-navigation
              :value="tabIndex"
              color="success"
              horizontal
            >
              <v-btn v-for="(item, index) of tabItems" @click="setPageStep(index)">
                <span style="font-size: 14px;">{{item.text}}</span>
                <v-icon>mdi-{{item.icon}}</v-icon>
              </v-btn>
            </v-bottom-navigation>
            <v-spacer></v-spacer>
            <v-btn color="success" style="width: 150px;" class="mr-3" @click="saveConfig">保存{{tabItems[tabIndex].text}}设计</v-btn>
          </v-card>
        </div>
        <!-- 表单设计 -->
        <div class="jh-page-body-container px-8 mt-4 d-flex">
          <!-- 页面设计 -->
          <v-tabs-items v-model="tabIndex" class="page-tabs-item">
            <v-tab-item :key="0" :value="0" class="pa-4">
              <template v-for="(item, key) of pageJsonContent">
                <template v-if="['pageContent', 'actionContent', 'headContent'].includes(key)"></template>
                <v-row v-else-if="typeof item === 'string'">
                  <v-col class="d-flex align-center">
                    <span style="text-align: right; display: inline-block; min-width: 100px; padding-right: 20px;">{{key}}:</span>
                    <v-text-field v-model="pageJsonContent[key]" class="jh-v-input" dense single-line filled style="flex: 1;"></v-text-field>
                  </v-col>
                </v-row>
                <div v-else-if="Array.isArray(item)">
                  <div style="padding: 12px;">{{key}}: {{item}}</div>
                </div>
                <div v-else>
                  <div style="padding: 12px;">{{key}}: {{item}}</div>
                </div>
              </template>
            </v-tab-item>
            <v-tab-item :key="1" :value="1" class="pa-4">
              <template v-for="(item, key) of headContent">
                <v-card>{{item}}</v-card>
              </template>
            </v-tab-item>
            <v-tab-item :key="2" :value="2" class="pa-4">
              <template v-for="(item, key) of pageContent">
                <v-card>{{item}}</v-card>
              </template>
            </v-tab-item>
            <v-tab-item :key="3" :value="3" class="pa-4">
              <template v-for="(item, key) of actionContent">
                <v-card>{{item}}</v-card>
              </template>
            </v-tab-item>
          </v-tabs-items>
          <!-- 右侧属性、配置面板 -->
        </div>
        <!-- <<<<<<<<<<<<< 头部内容 -->
        <!-- 设计区域 >>>>>>>>>>>>> -->
        
        <!-- <<<<<<<<<<<<< 设计区域 -->
      </v-main>
    </v-app>

    <jh-toast />
    <jh-mask />
    <jh-confirm-dialog />
  </div>
</script>
<div id="app"></div>
{% endblock %}

{% block vueScript %}
<script src="../lib/js/Sortable.min.js"></script>
<script src="../lib/js/vuedraggable.umd.min.js"></script>
<script>
  new Vue({
    el: '#app',
    template: '#app-template',
    vuetify: new Vuetify(),
    filters: {

    },
    data: () => ({
      workspaceFolders: "<$ workspaceFolders $>",
      projectPath: "<$ projectPath $>",
      pageId: "<$ pageId $>",
      appId: "<$ appId $>",
      webPageId: "<$ webPageId $>",
      panelId: "<$ panelId $>",
      jsonPath: "<$ jsonPath $>",
      hasHelpDrawer: "<$ hasHelpDrawer $>",
      // pageFile: "<$ pageFile $>",
      webPageName: "<$ webPageName $>",
      tabItems: [{ text: "基础信息", icon: "database-cog" }, { text: "头部设计", icon: "database-cog" }, { text: "页面设计", icon: "database-cog" }, { text: "抽屉设计", icon: "database-cog" },],
      tableTabIndex: "0",

      // END 表格的配置项目
      designConstants: {
        fieldType: ['int(11)', 'varchar(255)', 'text'],
        rowAction: [
          { text: '编辑', value: "doUiAction('startUpdateItem', item)" },
          { text: '删除', value: "doUiAction('deleteItem', item)" },
          { text: '查看', value: "doUiAction('viewItem', item)" }
        ],
        headAction: [{ text: '新增数据', value: 'startCreateItem' }, { text: '全选', value: 'selectAll' }, { text: '批量删除', value: 'deleteAll' }],
        doUiAction: [],
        dataType: [{ text: '纯文本', value: 'text' }, { text: '时间类型', value: 'dateTime' }, { text: '内容转换', value: 'parse' }],
        color: ["success", "error", "warning", "info", "primary", "secondary", "accent"],
      },

      fieldList: [
        { text: "单行文本", icon: "text-short", tag: "v-text-field" },
        { text: "多行文本", icon: "text-long", tag: "v-textarea" },
        { text: "下拉选项", icon: "form-dropdown", tag: "v-select" },
        { text: "单选", icon: "radiobox-marked", tag: "v-radio-group" },
        { text: "多选", icon: "checkbox-marked-outline", tag: "v-checkbox" },
        { text: "数字", icon: "numeric-10-box", tag: "v-text-field" },
        { text: "时间", icon: "clock-time-eight-outline", tag: "v-date-picker" },
        { text: "文件", icon: "file-code", tag: "v-file-input" },
        { text: "图片", icon: "image-outline", tag: "v-file-input" },
        { text: "区间", icon: "tune-variant", tag: "v-range-slider" },
        { text: "比例", icon: "percent-outline", tag: "v-slider" },
        { text: "开关", icon: "toggle-switch-off-outline", tag: "v-switch" },
        { text: "密码", icon: "lock-outline", tag: "v-otp-input" },
        { text: "搜索", icon: "feature-search-outline", tag: "v-autocomplete" },
        { text: "打分", icon: "star-box", tag: "v-rating" },
        { text: "JSON编辑器", icon: "star-box", tag: "jh-json-edit" },
      ],
      tabIndex: 0,
      tableFieldList: [],
      activeField: null,
      activeBtnItem: null,
      activeTh: null,
      activeData: null,
      // json数据
      pageJsonContent: {},
      actionContent: null,
      pageContent: null,
      headContent: null,
      priKey: null,
      tableHeaderListKey: "",
      headPlusBtnUid: null,
      tableRowSelect: [],
    }),
    computed: {
      tableHiddenHeaderList() {
        let hiddenFieldList = [];
        // table的隐藏字段
        if (this.tabIndex === 1) {
          hiddenFieldList = this.tableFieldList.filter(item => {
            return !this[`${this.tableHeaderListKey}`].some(header => header.value === item.Field);
          });
          if (!this[`${this.tableHeaderListKey}`].some(item => item.value === 'action')) {
            hiddenFieldList.push({ Field: 'action', Comment: '操作', Type: 'varchar(255)', Key: false, Default: null, });
          }
        }
        // 表单的隐藏字段
        if (this.tabIndex > 1 && this.tabIsActionContent) {
          const existFieldList = this.pickerFormField(this.actionContent[this.tabIndex - 2]);
          hiddenFieldList = this.tableFieldList.filter(item => {
            return !existFieldList.includes(item.Field);
          });
        }
        return hiddenFieldList;
      },
      // 当前激活字段的常量数据
      activeFieldConstants() {
        console.log("activeFieldConstants", this.modelKey)
        if (this.modelKey) {
          console.log("activeFieldConstants", this.constantObj)
          return this.constantObj[this.modelKey] || [];
        }
        return [];
      },
      activeFieldLabel() {
        if (this.activeField) {
          const fieldInput = this.activeField.value.find(item => item.tag && item.tag === 'v-text-field' || item.tag === 'v-select');
          return fieldInput.attrs["prefix"];
        }
        return null;
      },
      modelKey() {
        if (this.activeField) {
          const fieldInput = this.activeField.value.find(item => item.attrs && item.attrs["v-model"]);
          return fieldInput.attrs["v-model"].split(".")[1];
        }
        return null;
      },
      // 表单字段数据输入类型
      tagList() {
        return this.fieldList.map(item => item.tag);
      },
      // 是否包含表单
      tabIsActionContent() {
        if (this.tabIndex < 2) {
          return false;
        }
        return JSON.stringify(this.actionContent[this.tabIndex - 2]).includes("v-form");
      },
      // 表单字段的显示状态
      activeFieldShowStatus() {
        let status = false;
        if (this.activeField) {
          status = JSON.stringify(this.actionContent).includes(this.activeField.uid);
        }
        console.log("activeFieldShowStatus", status);
        return status;
      },
    },
    watch: {
      tabIndex(value) {
        if (value !== 1) {
          this.rowSelectChange = [];
          this.rowSelectSingleChange = [];
          this.dataTableHasSearchChange = [];
        }
      },
      priKey() {
        this.tableFieldList = this.tableFieldList.map(item => {
          if (item.Field === this.priKey) {
            item.Key = 'PRI';
          } else {
            item.Key = '';
          }
          return item;
        });
      },
      activeTh: {
        deep: true,
        handler(value) {
          console.log("activeTh", value);
          if (!value) {
            return;
          }
          this[`${this.tableHeaderListKey}`] = this[`${this.tableHeaderListKey}`].map(item => {
            if (item.value === value.value) {
              item = value;
              item.class = item.cellClass = value.fixed ? "fixed" : "";
            }
            return item;
          });
          if (value.itemKey) {
            // this[`${this.tableHeaderListKey}`] itemKey 是唯一的
            this[`${this.tableHeaderListKey}`] = this[`${this.tableHeaderListKey}`].map(item => {
              item.itemKey = item.value === value.value;
              return item;
            });
          }
        }
      },
    },
    async created() {
      await this.getPageConfig();
      await this.getDbFieldList();
    },
    mounted() {
    },
    methods: {
      async saveConfig() {
        switch (this.tabIndex) {
          case 0:
            await this.saveTableField();
            this.getDbFieldList();
            break;
          case 1:
            this.savePageContent();
            break;
          default:
            this.saveActionContent();
            break;
        }
      },

      // 数据表操作 start
      addNewTableField() {
        this.tableFieldList.push({
          Field: null,
          Comment: null,
          Type: "varchar(255)",
          Key: false,
          Default: null,
        });
      },
      // 数据表操作 end
      closePropertyContainer() {
        this.activeBtnItem = null;
        this.activeTh = null;
        this.activeData = null;
        this.activeField = null;
      },
      // 提取表单中的字段
      pickerFormField(item) {
        let fieldList = [];
        if (item.tag && this.tagList.includes(item.tag)) {
          fieldList.push(this.modelKey);
        }
        if (item.value && Array.isArray(item.value)) {
          item.value.forEach(value => {
            fieldList.push(...this.pickerFormField(value));
          });
        }
        return fieldList;
      },
      // 自动计算操作列的宽度
      resetActionWidth() {
        this[`${this.tableHeaderListKey}`].find((item, index) => {
          if (item.value === 'action') {
            let element = document.getElementsByTagName('td')[index];
            console.log(element.children);
            item.width = 0;
            for (let i = 0; i < element.children.length; i++) {
              item.width += element.children[i].offsetWidth;
            }
            console.log("action width", item.width);
            return true;
          }
          return false;
        })
      },

      // 获取数据库字段列表
      async getDbFieldList() {
        const result = await window.appAxios({
          packageType: "getFieldListRequest",
          data: {
            appData: {
              appId: this.appId,
              webPageId: this.webPageId,
              // pageFile: this.pageFile,
            },
          }
        })
        const { fieldList, error } = result.data.appData;
        this.tableFieldList = fieldList;
        this.priKey = fieldList.find(item => item.Key === 'PRI').Field;
      },
      // 获取页面配置 json
      async getPageConfig() {
        const designFieldConfigList = await window.appAxios({
          packageType: "getFieldConfigRequest",
          data: {
            appData: {
              appId: this.appId,
              webPageId: this.webPageId,
              pageJsonPath: this.jsonPath,
              // pageFile: this.pageFile,
            },
          }
        })
        this.pageJsonContent = designFieldConfigList.data.appData;
        if (this.pageJsonContent.error) {
          return;
        }
        this.tickTab();
        this.actionContent = this.pageJsonContent.actionContent;
        this.headContent = this.pageJsonContent.headContent;
        this.pageContent = this.pageJsonContent.pageContent;
      },
      tickTab() {
        const pageContentTabs = this.pageJsonContent.pageContent.filter(item => item.tag.startsWith('jh-'));
        const actionContentTabs = this.pageJsonContent.actionContent.filter(item => item.tag.startsWith('jh-'));
        const headContentTabs = this.pageJsonContent.headContent.filter(item => item.tag.startsWith('jh-'));
      },
      // 设计环节页面的切换
      setPageStep(index) {
        this.activeTh = null;
        this.activeBtnItem = null;
        this.activeData = null;
        this.activeField = null;

        this.tabIndex = index;
      },
      onStart() {
      },
      onEnd() {
      },
      // 移除选项
      removeOption(option) {
        if (!this.modelKey) {
          return;
        }
        this.constantObj[this.modelKey] = this.constantObj[this.modelKey].filter(item => typeof option === 'string' ? item !== option : item.text !== option.text);
        this.constantObj = _.cloneDeep(this.constantObj);
      },
      // 添加新的选项
      addNewOption() {
        if (!this.modelKey) {
          return;
        }
        if (!this.constantObj[this.modelKey]) {
          this.constantObj[this.modelKey] = [];
        }
        this.constantObj[this.modelKey].push({ text: "新选项", value: "新选项" });
        this.constantObj = _.cloneDeep(this.constantObj);
      },
      // 保存数据库字段列表
      async saveTableField() {
        // fieldName 不能为空
        // fieldType 不能为空
        const valid = this.tableFieldList.some(item => {
          if (!item.Field) {
            window.vtoast.fail("字段名称不能为空");
            return true;
          }
          if (!item.Type) {
            window.vtoast.fail("字段类型不能为空");
            return true;
          }
        })
        if (valid) {
          return;
        }
        // 发送数据
        if (!(await window.confirmDialog({ title: '保存', content: '确定保存字段吗？' }))) {
          return;
        }
        window.vtoast.loading("正在保存字段信息");
        await window.appAxios({
          packageType: "updateTableField",
          data: {
            appData: {
              pageId: this.pageId,
              appId: this.appId,
              webPageId: this.webPageId,
              // pageFile: this.pageFile,
              webPageName: this.webPageName,
              actionData: {
                fieldList: this.tableFieldList,
              }
            },
          },
          callback: (value) => {
            if (value.appData.isEnd) {
              window.vtoast.success("运行成功");
            }
          }
        })
      },
      // 保存抽屉的设计
      async saveActionContent() {
        window.vtoast.loading("正在保存抽屉配置");
        await window.appAxios({
          packageType: "updatePageContent",
          data: {
            appData: {
              pageId: this.pageId,
              appId: this.appId,
              webPageId: this.webPageId,
              webPageName: this.webPageName,
              actionData: {
                constantObj: this.constantObj,
                actionContent: this.actionContent,
                jsonPath: this.jsonPath,
              }
            },
          },
          callback: (value) => {
            if (value.appData.isEnd) {
              window.vtoast.success("运行成功");
            }
          }
        })
      },
      // 保存页面的配置
      async savePageContent() {
        // 验证数据
        // 1. 要把 header 重新覆盖下
        const newHeader = this[this.tableHeaderListKey];
        // 2. 要把 pageContent 重新覆盖下，排除掉 uid
        // 3. 要最最新的 json。通过命令生成到页面中
        // parse data
        const pageContent = _.cloneDeep(this.pageContent);
        this.removeById(pageContent, this.headPlusBtnUid);
        window.vtoast.loading("正在保存页面配置");
        await window.appAxios({
          packageType: "updatePageContent",
          data: {
            appData: {
              pageId: this.pageId,
              appId: this.appId,
              webPageId: this.webPageId,
              webPageName: this.webPageName,
              actionData: {
                header: newHeader,
                headerKey: this.tableHeaderListKey,
                pageContent,
                headContent: this.headContent,
                jsonPath: this.jsonPath,
                hasHelpDrawer: this.hasHelpDrawer,
                rootPath: `${this.projectPath}/`
              }
            },
          },
          callback: (value) => {
            if (value.appData.isEnd) {
              window.vtoast.success("运行成功");
            }
          }
        })

      },
    }
  })
</script>

<style scoped>
  body {
    padding: 0 !important;
  }

  .jh-page-body-container>.v-card {
    min-height: calc(100vh - 64px - 56px) !important;
  }

  .v-input .v-label {
    line-height: 1.45;
  }

  .page-tabs-item {
    min-height: calc(100vh - 120px) !important;
    width: 100%;
    border-radius: 5px;
  }

  .designContainerCardLeft {
    display: block;
  }

  .designContainerCardLeft>* {
    height: 100% !important;
  }

  .designContainerCard {
    max-width: 300px;
    min-width: 300px;
    margin-left: 20px;
  }

  .designContainer {
    max-width: 200px;
    min-width: 200px;
    border-right: 1px solid #EEEEEE;
    border-radius: 0 !important;
  }

  .designContainer.right {
    border-left: 1px solid #EEEEEE;
    border-right: 0 !important;
    padding-left: 12px;
  }

  .v-bottom-navigation .v-btn.v-btn--active {
    background-color: #e0ffe9;
  }

  .v-bottom-navigation {
    box-shadow: 0 1px 20px 0 rgb(0 0 0 / 2%) !important;
  }

  .designItemBoxDraggable>span {
    display: flex;
    flex-wrap: wrap;
  }

  body .activeDom {
    box-sizing: border-box;
    /* border: 1px dashed #333333; */
    position: relative;
  }

  body .activeDom::after {
    box-sizing: border-box;
    border: 1px dashed #333333;
    content: "";
    position: absolute;
    display: block;
    left: 1px;
    top: 1px;
    right: 1px;
    bottom: 1px;
  }

  span[role="button"] {
    white-space: nowrap;
  }

  .designItemBox .chosen {
    border: 1px dotted #333333;
    cursor: move;
  }

  .designItemBox .col-12:hover {
    border: 1px dotted #333333;
    cursor: move;
  }

  .designItemBox .col-12 .v-icon.mdi-close:hover {
    color: red;
  }

  .designItemBox .col-12 {
    border-radius: 8px;
    border: 1px dotted #FFFFFF;
  }

  .designItemBox .col-12.active {
    border: 1px dotted #333333;
    background-color: #fbfbfb;
  }

  .rulesBox .theme--light.v-btn-toggle .v-btn.v-btn--active {}

  .rulesBox .theme--light.v-btn-toggle .v-btn {
    border-radius: 4px !important;
    border: 1px solid #EEEEEE !important;
    margin-bottom: 3px !important;
    margin-right: 2px !important;
    max-height: 24px !important;
    font-size: 12px;
  }

  .rulesBox .v-btn-toggle {
    display: flex !important;
    flex-wrap: wrap;
  }

  .tableTabsBox .v-tab {
    padding: 0 !important;
  }

  .tableTabsBox .v-slide-group__prev,
  .tableTabsBox .v-slide-group__next {
    display: none !important;
  }

  .v-application .activeBtnItem {
    border: 1px dashed #333333 !important;
    background-color: transparent !important;
  }

  .v-data-table>.v-data-table__wrapper>table>tbody>tr>td.editing,
  .v-data-table--fixed-header>.v-data-table__wrapper>table>thead>tr>th.editing {
    border: 1px dashed #333333 !important;
  }

  .v-data-table>.v-data-table__wrapper>table>tbody>tr>td.isActionTd {
    white-space: nowrap !important;
  }

  .viewLeftListItem.v-list-item {
    position: relative;
    overflow: hidden;
    border: 1px solid #CCCCCC;
    border-radius: 5px;
    margin-bottom: 5px;
    margin-right: 10px;
    min-height: 35px !important;
  }

  .v-list-item.shown::after {
    content: "";
    background-color: #007220 !important;
    position: absolute;
    transform: rotate(45deg);
    top: -30px;
    right: -40px;
    width: 50px;
    height: 50px;
  }

  /* customStyle >>>>>> */

  /* <<<<<< customStyle */
</style>{% endblock %}