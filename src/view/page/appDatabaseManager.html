{% block htmlHead %}
<style>
  /* css */
</style>
{% endblock %}

{% extends 'template/jhsTemplate.html'%}
{% block vueTemplate %}

<script type="text/html" id="app-template">
  <div>
    <v-app mobile-breakpoint="sm">
      <v-main class="mt-5">
        <!-- 头部内容 >>>>>>>>>>>>> -->
        <div class="jh-page-second-bar px-8">
          <v-row class="align-center" dense>
            <v-col cols="12" xs="12" sm="12" md="8" xl="8">
              <div class="py-4 font-weight-bold d-flex align-center" style="font-size: 30px;">【{{appId}}】数据库管理</div>
            </v-col>
            <v-spacer></v-spacer>
          </v-row>
        </div>
        <!-- <<<<<<<<<<<<< 头部内容 -->

        <!-- 页面内容 >>>>>>>>>>>>> -->
        <div class="jh-page-body-container px-8">
          <v-card class="rounded-lg pa-4 pt-6">
            <v-data-table fixed-header :headers="headers" :items="databaseList" :search="searchInput"
              :footer-props="{ itemsPerPageOptions: [20, 40, 60, 100, -1] }" :items-per-page="20" :loading="isTableLoading"
              checkbox-color="success" mobile-breakpoint="0" class="elevation-0 mt-0 mb-xs-4 flex-fill d-flex flex-column">
              <template v-slot:item.action="{ item }">
                <span role="button" class="success--text font-weight-medium font-size-2 mr-2" @click="viewTableData(item)">
                  <v-icon size="16" class="success--text">mdi-table</v-icon>查看数据
                </span>

              </template>
            </v-data-table>
            <div v-if="logInfo">启动日志：{{logInfo}}</div>
          </v-card>
        </div>

        <v-navigation-drawer
          v-model="isTableDataDialogShown"
          :permanent="isTableDataDialogShown"
          fixed
          temporary
          right
          width="80%"
          class="elevation-24"
        >
        <v-row class="jh-drawer-header px-4" no-gutters align="center">
          <span class="text-h7 font-weight-bold py-4">{{ selectedTable ? selectedTable.tableName : '' }} 数据</span>
          <v-spacer ></v-spacer>
          <div class="jh-drawer-action-btn-group">
              
          </div>
        </v-row>

        <v-divider class="jh-divider"></v-divider>

          <v-data-table
            :headers="tableheaders"
            :items="tableData"
            :footer-props="{ itemsPerPageOptions: [20, 50, 200, -1], itemsPerPageText: '每页', itemsPerPageAllText: '所有'}"
            :items-per-page="-1"
            mobile-breakpoint="0"
            :loading="isTableLoading"
            checkbox-color="success"
            :class="{'zebraLine': true }"
            height="500"
            fixed-header
            class="jh-fixed-table-height elevation-0 mt-0 mb-xs-4"
          >
            <!-- 没有数据 -->
            <template v-slot:loading>
              <div class="jh-no-data">数据加载中</div>
            </template>
            <template v-slot:no-data>
              <div class="jh-no-data">暂无数据</div>
            </template>
            <template v-slot:no-results>
              <div class="jh-no-data">暂无数据</div>
            </template>
            <!-- 表格分页 -->
            <template v-slot:footer.page-text="pagination">
              <span>{{pagination.pageStart}}-{{pagination.pageStop}}</span>
              <span class="ml-1">共{{pagination.itemsLength}}条</span>
            </template>
          </v-data-table>
          <v-btn
            elevation="0"
            color="success"
            fab
            absolute
            top
            left
            small
            tile
            class="drawer-close-float-btn"
            @click="isTableDataDialogShown = false"
          >
            <v-icon>mdi-close</v-icon>
          </v-btn>
        </v-navigation-drawer>
      </v-main>
    </v-app>

    <jh-toast />
    <jh-mask />
    <jh-confirm-dialog />
  </div>
</script>
<div id="app"></div>
{% endblock %}
{% include 'common/jianghuJs/fixedTableHeightV4.html' %}

{% block vueScript %}

<script>
  new Vue({
    el: '#app',
    template: '#app-template',
    vuetify: new Vuetify(),
    data: () => ({
      workspaceFolders: "<$ workspaceFolders $>",
      pageId: "<$ pageId $>",
      appId: "<$ appId $>",
      rules: {
        required: value => !!value || 'Required.',
      },
      databaseList: [],
      searchInput: null,
      isTableLoading: true,
      constantObj: {
        pageType: [
          { text: '顶部菜单 [showInMenu]', value: 'showInMenu' },
          { text: '隐藏菜单 [dynamicInMenu]', value: 'dynamicInMenu' },
        ],
      },
      headers: [
        { text: "表名", tips: "数据库表名", value: "tableName", width: 150 },
        { text: "引擎", tips: "数据库引擎", value: "engine", width: 100 },
        { text: "行数", tips: "表中的行数", value: "rows", width: 100 },
        { text: "数据长度", tips: "数据长度(字节)", value: "dataLength", width: 120 },
        { text: "索引长度", tips: "索引长度(字节)", value: "indexLength", width: 120 },
        { text: "创建时间", tips: "表的创建时间", value: "createTime", width: 180 },
        { text: "更新时间", tips: "表的最后更新时间", value: "updateTime", width: 180 },
        { text: "注释", tips: "表的注释", value: "comment", width: 150 },
        { text: '操作', value: 'action', align: 'center', sortable: false, width: 150 },
      ],

      tableheaders: [],
      isFormDrawerShown: false,
      pageForm: {},
      logInfo: null,
      tables: [],
      selectedTable: null,
      tableData: [],
      tablePagination: {
        page: 1,
        itemsPerPage: 10,
        totalItems: 0,
      },
      isTableDataDialogShown: false,
    }),
    computed: {
      formFeilds() {
        return this.headers.filter(item => item.edit !== false).map(item => ({ ...item, rule: item.required ? [this.rules.required] : [] }));
      },
    },
    watch: {

    },

    created() {
      this.doUiAction("getDatabaseList");
    },
    mounted() {
    },
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case 'getDatabaseList':
            await this.getDatabaseList();
            break;
          case 'startSaveForm':
            this.saveForm();
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },
      startUpdateItem(item) {
        this.pageForm = { ...item };
        this.isFormDrawerShown = true;
      },
      startAddItem() {
        this.pageForm = {};
        this.isFormDrawerShown = true;
      },
      async startDesignItem(item) {
        if (!item.canDesign) {
          window.vtoast.fail("该页面不支持设计");
          return;
        }
        await window.appAxios({
          packageType: "pageDesignRequest",
          isVoid: true,
          data: {
            appData: {
              pageInfo: item,
            },
          },
        });
      },
      async saveForm() {
        if (!(await this.$refs.pageForm.validate())) {
          window.vtoast.fail("数据不准确");
          return;
        }
        this.isTableLoading = true;
        const { id, ...data } = this.pageForm;
        if (id) {
          delete data.canDesign;
        }
        await window.appAxios({
          packageType: id ? "messageRequest" : "createPageRequest",
          data: {
            appData: {
              pageId: "pageManager",
              actionId: id ? "updateItem" : "createItem",
              actionData: data,
              where: { id },
            },
          },
        });
        this.pageForm = {};
        this.isFormDrawerShown = false;
        await this.getDatabaseList();
        this.isTableLoading = false;
      },
      async startViewItem(item) {
        // 预览页面
        item.runView = true;
        window.vtoast.loading({ message: "正在启动预览页面", time: -1 });
        await window.appAxios({
          packageType: "viewPageRequest",
          data: {
            appData: {
              webPageId: item.pageId,
              appId: this.appId,
              workspaceFolders: this.workspaceFolders,
            },
          },
          callback: (value) => {
            this.logInfo = value.appData.message;
            console.log('正在启动预览页面 res', value);
            if (value.appData.isEnd) {
              item.runView = false;
              if (value.appData.state && value.appData.state === 'fail') {
                window.vtoast.fail("启动项目失败，请检查项目配置");
              } else {
                window.vtoast.success("预览启动成功");
              }
            }
          }
        });
        item.runView = false;
      },
      async getDatabaseList() {
        this.isTableLoading = true;
        const { data: { appData: { resultData: { rows } } } } = await window.appAxios({
          data: {
            appData: {
              pageId: "databaseManager",
              actionId: "getAllTables",
            },
          }
        });
        console.log('getDatabaseList', rows);
        this.databaseList = rows;
        this.isTableLoading = false;
      },

      async viewTableData(table) {
        this.selectedTable = table;
        this.tablePagination.page = 1;
        await this.getTableData();
        this.isTableDataDialogShown = true;
      },

      async getTableData() {
        const { data: { appData: { resultData } } } = await window.appAxios({
          data: {
            appData: {
              pageId: "databaseManager",
              actionId: "getTableData",
              actionData: {
                tableName: this.selectedTable.tableName,
                page: this.tablePagination.page,
                pageSize: this.tablePagination.itemsPerPage,
              },
            },
          }
        });
        this.tableData = resultData.rows;
        this.tablePagination.totalItems = resultData.total;
        
        // 根据rows的key来设置tableheaders
        if (this.tableData.length > 0) {
          this.tableheaders = Object.keys(this.tableData[0]).map(key => ({
            text: key,
            value: key
          }));
        } else {
          this.tableheaders = [];
        }
      },
    }
  })
</script>

<style scoped>
  .v-input .v-label {
    line-height: 1.45;
  }

  span[role="button"].disabled {
    color: #CCCCCC !important;
  }

  span[role="button"].disabled .v-icon {
    color: #CCCCCC !important;
  }
</style>{% endblock %}
