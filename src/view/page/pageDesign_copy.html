{% block htmlHead %}
<style>
  /* css */
</style>
{% endblock %}

{% extends 'template/jhsTemplate.html'%}
{% block vueTemplate %}
<script type="text/html" id="app-template">
  <div>
    <v-app mobile-breakpoint="sm">
      <v-main>
        <!-- 头部内容 >>>>>>>>>>>>> -->
        <div class="px-8 py-0 mt-4 designPageHead">
          <v-card class="rounded-lg d-flex" style="align-items: center;">
            <v-bottom-navigation
              :value="tabIndex"
              color="success"
              horizontal
            >
              <v-btn v-for="(item, index) of tabItems" @click="setPageStep(index)">
                <span style="font-size: 14px;">{{item.text}}</span>
                <v-icon>mdi-{{item.icon}}</v-icon>
              </v-btn>
            </v-bottom-navigation>
            <v-spacer></v-spacer>
            <v-btn color="success" style="width: 150px;" class="mr-3" @click="saveConfig">保存{{tabItems[tabIndex].text}}设计</v-btn>
          </v-card>
        </div>
        <!-- 表单设计 -->
        <div class="jh-page-body-container px-8 mt-4 d-flex">
          <!-- 字段设计 -->
          <v-card class="rounded-lg pa-4" style="max-height: calc(100vh - 200px); overflow-y: auto; flex: 1;" v-if="tabIndex === 0">
            <div class="d-flex">
              <div style="flex: 1; max-width: 50px; margin-right: 20px;">主键</div>
              <div style="flex: 1; margin-right: 20px;">字段名</div>
              <div style="flex: 1; margin-right: 20px;">字段类型</div>
              <div style="flex: 1; margin-right: 20px;">字段说明</div>
              <div style="flex: 1; margin-right: 20px;">默认值</div>
            </div>
            <v-radio-group v-model="priKey">
              <template v-for="item of tableFieldList">
                <div class="d-flex">
                  <div style="flex: 1; max-width: 50px; margin-right: 20px;">
                    <v-radio :value="item.Field" ></v-radio>
                  </div>
                  <div style="flex: 1; margin-right: 20px;">
                    <v-text-field class="jh-v-input" dense filled single-line v-model="item.Field"></v-text-field>
                  </div>
                  <div style="flex: 1; margin-right: 20px;">
                    <v-select :items="['int(11)', 'varchar(255)']" v-model="item.Type" dense filled single-line></v-select>
                  </div>
                  <div style="flex: 1; margin-right: 20px;">
                    <v-text-field class="jh-v-input" dense single-line filled v-model="item.Comment"></v-text-field>
                  </div>
                  <div style="flex: 1; margin-right: 20px;">
                    <v-text-field class="jh-v-input" dense single-line filled v-model="item.Default"></v-text-field>
                  </div>
                </div>
              </template>
            </v-radio-group>
            <div class="d-flex">
              <v-btn class="mr-4 mt-0" @click="addNewTableField"><v-icon>mdi-plus</v-icon>新增字段</v-btn>
              <v-spacer></v-spacer>
            </div>
          </v-card>
          <!-- 页面设计 -->
          <div class="designContainerCardLeft" v-if="tabIndex === 1">
            <div class="d-flex flex-column">
              <template v-for="item of headContentStudio">
                <custom-component v-if="item.tag" :dom-item="item" :key="item.uid" :uid="item.uid" style="padding: 0!important;" :is-header="true"></custom-component>
                <span v-else>{{item}}</span>
              </template>
              <div style="flex: 1">
                <template v-for="item of pageContent">
                  <custom-component v-if="item.tag" :dom-item="item" :key="item.uid" :uid="item.uid" style="height: 100%" :is-page-content="true"></custom-component>
                  <span v-else>{{item}}</span>
                </template>
              </div>
            </div>
          </div>
          <template v-for="(item, index) of actionContent">
            <div class="designContainerCardLeft" v-if="tabIndex === index + 2">
              <v-card class="rounded-lg pa-4" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <template v-for="item2 of item.value">
                  <custom-component v-if="item2.tag" :dom-item="item2" :key="item2.uid" :uid="item2.uid" :is-action-content="true"></custom-component>
                  <span v-else>{{item2}}</span>
                </template>
              </v-card>
            </div>
          </template>
          <!-- 右侧属性、配置面板 -->
          <v-card class="designContainerCard rounded-lg pa-4" v-if="tabIndex > 0">
            <!-- 按钮的配置 -->
            <template v-if="activeBtnItem">
              <v-row class="ma-0 pa-2">
                <v-icon color="success" size="18">mdi-information</v-icon>
                <span style="line-height: 36px; font-size: 14px; font-weight: bold; padding-left: 12px;">按钮属性</span></span>
                <v-spacer></v-spacer>
                <v-icon size="20" color="red" @click="closePropertyContainer">mdi-close-circle</v-icon>
              </v-row>
              <v-divider></v-divider>
              <v-row class="mt-4" v-if="!activeBtnItem.isHeader">
                <v-spacer></v-spacer>
                <v-btn color="red" class="mr-4" dark small @click="removeBtn">移除按钮</v-btn>
              </v-row>
              <v-row class="mt-4">
                <v-col>
                  <v-text-field label="按钮位置" placeholder="按钮位置" readonly hide-details outlined dense :value="activeBtnItem.isHeader ? '服务段搜索' : (activeBtnItem.type === 'headAction' ? '表格头按钮' : '数据行按钮')"></v-text-field>
                </v-col>
              </v-row>
              <v-row>
                <v-col>
                  <v-select label="按钮事件" placeholder="按钮类型" @change="activeBtnItemTypeChange" :disabled="activeBtnItem.isHeader" :items="designConstants.doUiAction" hide-details outlined dense :value="tickEventValue"></v-select>
                </v-col>
              </v-row>
              <v-row class="mt-4">
                <v-col>
                  <v-text-field label="按钮文字" placeholder="按钮文字" hide-details outlined dense v-model="activeBtnItem.value[activeBtnItem.tag !== 'v-btn' ? 1 : 0]"></v-text-field>
                </v-col>
              </v-row>
              <v-row v-if="activeBtnItem.tag !== 'v-btn' && !activeBtnItem.isHeader">
                <v-col>
                  <v-text-field label="按钮图标(选填)" :append-icon="activeBtnItem.value[0].value[0]" placeholder="按钮图标" hide-details outlined dense v-model="activeBtnItem.value[0].value[0]"></v-text-field>
                </v-col>
              </v-row>
              <v-row>
                <v-col>
                  <v-select label="按钮颜色" placeholder="按钮颜色" :items="designConstants.color" hide-details outlined dense :value="activeBtnItem.color" @change="btnColorChange"></v-select>
                </v-col>
              </v-row>
            </template>
            <!-- 表格头的配置 -->
            <template v-else-if="activeTh">
              <v-row class="ma-0 pa-2">
                <v-icon color="success" size="18">mdi-information</v-icon>
                <span style="line-height: 36px; font-size: 14px; font-weight: bold; padding-left: 12px;">表单字段属性</span></span>
                <v-spacer></v-spacer>
                <v-icon size="20" color="red" @click="closePropertyContainer">mdi-close-circle</v-icon>
              </v-row>
              <v-divider></v-divider>
              <v-row class="mt-2">
                <v-col>
                  <v-row class="ma-0 pa-0">
                    <span>字段名</span>
                    <v-spacer></v-spacer>
                  </v-row>
                  <div class="d-flex">
                    <v-text-field hide-details outlined dense v-model="activeTh.text"></v-text-field>
                  </div>
                </v-col>
              </v-row>
              <v-row class="mt-2">
                <v-col>
                  <v-row class="ma-0 pa-0">
                    <span>字段Key</span>
                    <v-spacer></v-spacer>
                    <span style="color: #999999; font-size: 12px;">（类型：{{activeTh.Type}}）</span>
                  </v-row>
                  <div class="d-flex">
                    <v-text-field disabled hide-details outlined dense :value="activeTh.value"></v-text-field>
                  </div>
                </v-col>
              </v-row>
              <v-row>
                <v-col>
                  <v-row class="ma-0 pa-0">
                    <span>显示顺序<v-icon size="14" color="red">mdi-swap-horizontal</v-icon></span>
                    <v-spacer></v-spacer>
                    <span style="color: #999999;">（index：{{activeTh.index}}）</span>
                  </v-row>
                  <div class="d-flex">
                    <v-btn @click="tdMove(activeTh, -999)" color="gray" outlined small class="px-2" style="min-width: 30px;"><v-icon size="14">mdi-arrow-collapse-left</v-icon></v-btn>
                    <v-btn @click="tdMove(activeTh, -1)" color="gray" outlined small class="px-2" style="min-width: 30px;"><v-icon size="14">mdi-arrow-left</v-icon></v-btn>
                    <v-spacer></v-spacer>
                    <v-btn @click="tdMove(activeTh, 1)" color="gray" outlined small class="px-2" style="min-width: 30px;"><v-icon size="14">mdi-arrow-right</v-icon></v-btn>
                    <v-btn @click="tdMove(activeTh, 999)" color="gray" outlined small class="px-2" style="min-width: 30px;"><v-icon size="14">mdi-arrow-collapse-right</v-icon></v-btn>
                  </div>
                </v-col>
              </v-row>
              <v-row class="ma-0 pa-0 mt-4 align-center">
                  <span>列宽度<v-icon size="14" color="red">mdi-arrow-left-right</v-icon></span>
                  <v-spacer></v-spacer>
                  <v-text-field hide-details outlined dense style="max-width: 63px;" v-model="activeTh.width"></v-text-field>
              </v-row>
              <v-row class="ma-0 pa-0 mt-4 align-center" v-if="activeTh.value !== 'action'">
                  <span>数据主键<v-icon size="14" color="red">mdi-key</v-icon></span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" class="mt-0" dense inset hide-details v-model="activeTh.itemKey"></v-switch>
              </v-row>
              <v-row class="ma-0 pa-0 mt-4 align-center">
                  <span>列显示<v-icon size="14" color="red">mdi-eye</v-icon></span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" class="mt-0" dense inset hide-details v-model="activeTh.shown" @change="fieldShownChange"></v-switch>
              </v-row>
              <v-row class="ma-0 pa-0 mt-4 align-center">
                  <span>列固定<v-icon size="14" color="red">mdi-lock</v-icon></span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" class="mt-0" dense inset hide-details v-model="activeTh.fixed"></v-switch>
              </v-row>
              <v-row class="ma-0 pa-0 mt-4 align-center">
                  <span>行排序<v-icon size="14" color="red">mdi-swap-vertical</v-icon></span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" class="mt-0" dense inset hide-details v-model="activeTh.sortable"></v-switch>
              </v-row>
            </template>
            <!-- 数据的配置 -->
            <template v-else-if="activeData">
              <v-row class="ma-0 pa-2">
                <v-icon color="success" size="18">mdi-format-line-style</v-icon>
                <span style="line-height: 36px; font-size: 14px; font-weight: bold; padding-left: 12px;">数据显示配置</span></span>
                <v-spacer></v-spacer>
                <v-icon size="20" color="red" @click="closePropertyContainer">mdi-close-circle</v-icon>
              </v-row>
              <v-divider></v-divider>
              <v-row class="mt-2">
                <v-col>
                  <v-row class="ma-0 pa-0">
                    <span>数据显示方式</span>
                    <v-spacer></v-spacer>
                  </v-row>
                  <div class="d-flex">
                    <v-select :items="designConstants.dataType" hide-details outlined dense v-model="activeData.dataType"></v-select>
                  </div>
                </v-col>
              </v-row>
            </template>
            <!-- 页面的配置 -->
            <template v-else-if="tabIndex === 1">
              <!-- 表单单项配置 -->
              <template v-if="activeField">
                <v-row class="ma-0 pa-2">
                  <v-icon color="success" size="18">mdi-information</v-icon>
                  <span style="line-height: 36px; font-size: 14px; font-weight: bold; padding-left: 12px;">{{activeField.isHeader ? '服务端搜索项属性' : '筛选框属性'}}</span></span>
                  <v-spacer></v-spacer>
                  <v-icon size="20" color="red" @click="closePropertyContainer">mdi-close-circle</v-icon>
                </v-row>
                <v-divider class="mb-4"></v-divider>
                <!-- table的字段备注 -->
                <v-select :items="tableFieldListForSelect" label="字段绑定" outlined dense :value="modelKey" @change="onServerSearchFieldBind"></v-select>
                <v-select :items="['v-text-field', 'v-select']" label="筛选方式" outlined dense v-model="serverSearchType" @change="onServerSearchTypeChange"></v-select>
                <v-text-field label="字段前缀" outlined hide-details dense :value="activeFieldLabel" @input="onServerSearchFieldLabelChange"></v-text-field>
                <div v-if="serverSearchType === 'v-select'">
                  <v-divider class="mb-4"></v-divider>
                    <div class="d-flex align-center"><span>选项</span><v-spacer></v-spacer><v-btn icon dense @click="addNewOption"><v-icon>mdi-plus</v-icon></v-btn></div>
                    <div v-if="!activeFieldConstants.length" class="pb-4 pt-2 text-center" style="color: #999999;">暂无选项配置</div>
                    <div v-else class="d-flex" v-for="(option, index) of activeFieldConstants">
                      <v-text-field :label="option" :placeholder="option" v-if="typeof option === 'string'" outlined dense v-model="activeFieldConstants[index]"></v-text-field>
                      <div v-else class="d-flex align-center">
                        <v-text-field style="flex: 1;" label="文字" placeholder="文字" outlined dense v-model="activeFieldConstants[index].text"></v-text-field>
                        <v-text-field style="flex: 1;" label="值" placeholder="值" outlined dense v-model="activeFieldConstants[index].value"></v-text-field>
                      </div>
                      <v-btn icon dense><v-icon size="16" @click="removeOption(option)">mdi-close</v-icon></v-btn>
                    </div>
                </div>
              </template>
              <!-- 页面配置 -->
              <template v-else>
                <v-row class="ma-0 pa-2">
                  <v-icon color="success" size="18">mdi-cog</v-icon>
                  <span style="line-height: 36px; font-size: 14px; font-weight: bold; padding-left: 12px;">页面配置</span>
                  <v-spacer></v-spacer>
                </v-row>
                <v-divider></v-divider>
                <div class="d-flex align-center" style="height: 60px;">
                  <span style="min-width: 60px;">主题颜色</span>
                  <v-spacer></v-spacer>
                  <div class="d-flex align-center">
                    <div :style="{'background-color': cPrimaryColor}" style="width: 32px; height: 32px; border-radius: 5px; margin-right: 10px;"></div>
                    <v-text-field outlined hide-details dense v-model="cPrimaryColor"></v-text-field>
                  </div>
                </div>
                <div class="d-flex align-center" style="height: 60px;" v-if="pageTitleCol">
                  <span style="min-width: 60px;">页面标题</span>
                  <v-spacer></v-spacer>
                  <v-text-field outlined hide-details dense v-model="pageTitleCol.value[0]"></v-text-field>
                </div>
                <div class="d-flex align-center" style="height: 60px;">
                  <span style="min-width: 60px;">帮助开关</span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" dense inset value v-model="hasHelpDrawer" @change="onHasHelpDrawerChange"></v-switch>
                </div>
                <div class="d-flex align-center" style="height: 60px;">
                  <span style="min-width: 60px;">服务端搜索</span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" dense inset value v-model="hasServerSearch" @change="onServerSearch"></v-switch>
                </div>
                <div class="d-flex align-center" style="height: 60px;">
                  <span style="min-width: 60px;">行选择</span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" dense inset value :input-value="rowSelect" @change="onRowSelectChange"></v-switch>
                </div>
                <div class="d-flex align-center" style="height: 60px;">
                  <span style="min-width: 60px;">行单选</span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" dense inset value :input-value="rowSelectSingle" @change="onrowSelectSingleChange"></v-switch>
                </div>
                <div class="d-flex align-center" style="height: 60px;">
                  <span style="min-width: 60px;">表格搜索</span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" dense inset value :input-value="dataTableHasSearch" @change="onDataTableHasSearchChange"></v-switch>
                </div>
              </template>
            </template>
            <!-- 表单属性配置 -->
            <template v-if="tabIsActionContent">
              <template v-if="activeField">
                <v-row class="ma-0 pa-2">
                  <v-icon color="success" size="18">mdi-information</v-icon>
                  <span style="line-height: 36px; font-size: 14px; font-weight: bold; padding-left: 12px;">表单字段配置</span>
                  <v-spacer></v-spacer>
                  <v-icon size="20" color="red" @click="closePropertyContainer">mdi-close-circle</v-icon>
                </v-row>
                <v-divider class="mb-4"></v-divider>
                <!-- table的字段备注 -->
                <v-text-field label="字段" placeholder="字段" outlined dense v-model="activeField.value[0].value[0]"></v-text-field>
                <!-- table的字段名 -->
                <v-text-field label="字段名称" placeholder="字段名称" :disabled="activeField.value[1].attrs.disabled" outlined dense v-model="activeField.value[1].attrs['v-model']"></v-text-field>
                <v-select :items="tagList" label="表单类型" outlined dense v-model="activeField.value[1].tag" @change="onFormFieldTypeChange"></v-select>
                <!-- 多行的行数 -->
                <v-text-field v-if="activeField.value[1].tag === 'v-textarea'" label="行数" placeholder="行数" outlined dense v-model="activeField.value[1].attrs.rows"></v-text-field>
                <!-- 滑块的最大和最小 -->
                <v-text-field v-if="['v-range-slider', 'v-slider'].includes(activeField.value[1].tag)" label="最小值" placeholder="最小值" outlined dense v-model="activeField.value[1].attrs.min"></v-text-field>
                <v-text-field v-if="['v-range-slider', 'v-slider'].includes(activeField.value[1].tag)" label="最大值" placeholder="最大值" outlined dense v-model="activeField.value[1].attrs.max"></v-text-field>
                <!-- 数字的最大和最小 -->
                <v-text-field v-if="['v-text-field'].includes(activeField.value[1].tag) && activeField.value[1].attrs.type === 'number'" label="最小值" placeholder="最小值" outlined dense v-model="activeField.value[1].attrs.min"></v-text-field>
                <v-text-field v-if="['v-text-field'].includes(activeField.value[1].tag) && activeField.value[1].attrs.type === 'number'" label="最大值" placeholder="最大值" outlined dense v-model="activeField.value[1].attrs.max"></v-text-field>
                <!-- 时间的最大和最小 -->
                <v-text-field v-if="['v-date-picker'].includes(activeField.value[1].tag)" label="开始时间" placeholder="开始时间" outlined dense v-model="activeField.value[1].attrs.startTime"></v-text-field>
                <v-text-field v-if="['v-date-picker'].includes(activeField.value[1].tag)" label="结束时间" placeholder="结束时间" outlined dense v-model="activeField.value[1].attrs.endTime"></v-text-field>
                <!-- 字段显隐 -->
                <v-row class="ma-0 pa-0 mb-4 align-center">
                  <span>字段显隐<v-icon size="14" color="red">mdi-eye</v-icon></span>
                  <v-spacer></v-spacer>
                  <v-switch color="success" class="mt-0" dense inset hide-details value :input-value="activeFieldShowStatus" @change="fieldShownChange"></v-switch>
                </v-row>
                <!-- 下拉、单选、多选的选项配置 -->
                <div v-if="needItemsField.includes(activeField.value[1].tag)">
                  <v-divider class="mb-4"></v-divider>
                    <div class="d-flex align-center"><span>选项</span><v-spacer></v-spacer><v-btn icon dense @click="addNewOption"><v-icon>mdi-plus</v-icon></v-btn></div>
                    <div v-if="!activeFieldConstants.length" class="pb-4 pt-2 text-center" style="color: #999999;">暂无选项配置</div>
                    <div v-else class="d-flex" v-for="(option, index) of activeFieldConstants">
                      <v-text-field :label="option" :placeholder="option" v-if="typeof option === 'string'" outlined dense v-model="activeFieldConstants[index]"></v-text-field>
                      <div v-else class="d-flex align-center">
                        <v-text-field style="flex: 1;" label="文字" placeholder="文字" outlined dense v-model="activeFieldConstants[index].text"></v-text-field>
                        <v-text-field style="flex: 1;" label="值" placeholder="值" outlined dense v-model="activeFieldConstants[index].value"></v-text-field>
                      </div>
                      <v-btn icon dense><v-icon size="16" @click="removeOption(option)">mdi-close</v-icon></v-btn>
                    </div>
                </div>
                <!-- 组件在页面中的横向占比 -->
                <div class="mb-4">
                  <v-divider class="mb-4"></v-divider>
                    <span>表单占比</span>
                    <v-btn-toggle dense v-model="activeField.attrs.md" color="success">
                      <v-btn v-for="col in [4,6,8,12]" class="px-1" :key="col" :value="col" style="font-size: 12px;" outlined>{{parseInt(col/12*100)}}%</v-btn>
                    </v-btn-toggle>
                </div>
                <!-- rules -->
                <!-- <div class="rulesBox">
                    <span>字段规则</span>
                    <v-btn-toggle dense v-model="activeField.attrs.rules" multiple color="success" >
                      <v-btn v-for="(rule, ruleKey) in rules" :key="ruleKey" :value="ruleKey" outlined>{{rule.name}}</v-btn>
                    </v-btn-toggle>
                </div> -->
              </template>
            </template>
            <!-- 隐藏字段 -->
            <template v-if="tabIndex === 1 || tabIsActionContent">
              <v-divider class="mt-4"></v-divider>
              <v-row class="ma-0 pa-2">
                <v-icon color="success" size="18">mdi-database-eye-outline</v-icon>
                <span style="line-height: 36px; font-size: 14px; font-weight: bold; padding-left: 12px;">未显示字段</span>
                <v-spacer></v-spacer>
              </v-row>
              <v-divider></v-divider>
              <div class="d-flex align-center" style="max-height: 360px; overflow-y: auto;">
                <v-list dense v-if="tableHiddenHeaderList && tableHiddenHeaderList.length">
                  <v-list-item two-line class="px-0" v-for="(item, index) of tableHiddenHeaderList" :key="index" @click="onHiddenFieldTap(item)">
                    <v-list-item-content>
                      <v-list-item-title>{{item.Field}} <span style="color: #999999;">[{{item.Type}}]</span></v-list-item-title>
                      <v-list-item-subtitle>{{item.Comment}}</v-list-item-subtitle>
                    </v-list-item-content>
                  </v-list-item>
                </v-list>
                <div v-else style="text-align: center; line-height: 50px; color: #999999; width: 100%;">
                  字段已全部显示
                </div>
              </div>
            </template>
          </v-card>
        </div>
        <!-- <<<<<<<<<<<<< 头部内容 -->
        <!-- 设计区域 >>>>>>>>>>>>> -->
        
        <!-- <<<<<<<<<<<<< 设计区域 -->
      </v-main>
    </v-app>

    <jh-toast />
    <jh-mask />
    <jh-confirm-dialog />
  </div>
</script>
<div id="app"></div>
{% endblock %}

{% block vueScript %}
<script src="../lib/js/Sortable.min.js"></script>
<script src="../lib/js/vuedraggable.umd.min.js"></script>
<script>
  new Vue({
    el: '#app',
    template: '#app-template',
    vuetify: new Vuetify(),
    filters: {
      toText(value) {
        if (!value) {
          return "";
        }
        if (Array.isArray(value)) {
          return value.join(",");
        }
        return value;
      }
    },
    data: () => ({
      workspaceFolders: "<$ workspaceFolders $>",
      projectPath: "<$ projectPath $>",
      pageId: "<$ pageId $>",
      appId: "<$ appId $>",
      webPageId: "<$ webPageId $>",
      panelId: "<$ panelId $>",
      jsonPath: "<$ jsonPath $>",
      hasHelpDrawer: "<$ hasHelpDrawer $>",
      // pageFile: "<$ pageFile $>",
      webPageName: "<$ webPageName $>",
      tabItems: [{ text: "字段设计", icon: "database-cog" }, { text: "页面设计", icon: "language-html5" },],
      tableTabIndex: "0",
      // 表格的配置项目
      rowSelect: false,
      rowSelectSingle: false,
      dataTableHasSearch: false,
      dataTableHasSearchKey: null,
      tableDataKey: null,
      tableHeadRow: null,
      pageTitleCol: null,
      hasServerSearch: false,
      activeBtnForceUpdate: null,
      // 方法映射
      rowSelectChange: [],
      rowSelectSingleChange: [],
      dataTableHasSearchChange: [],
      onHasHelpDrawerChange: () => { },
      // END 表格的配置项目
      designConstants: {
        fieldType: ['int(11)', 'varchar(255)', 'text'],
        rowAction: [
          { text: '编辑', value: "doUiAction('startUpdateItem', item)" },
          { text: '删除', value: "doUiAction('deleteItem', item)" },
          { text: '查看', value: "doUiAction('viewItem', item)" }
        ],
        headAction: [{ text: '新增数据', value: 'startCreateItem' }, { text: '全选', value: 'selectAll' }, { text: '批量删除', value: 'deleteAll' }],
        doUiAction: [
          //===//<$ common.doUiAction | eventStepFormat | safe $>
        ],
        dataType: [{ text: '纯文本', value: 'text' }, { text: '时间类型', value: 'dateTime' }, { text: '内容转换', value: 'parse' }],
        color: ["success", "error", "warning", "info", "primary", "secondary", "accent"],
      },

      rules: {
        required: {
          name: "必填",
          fun: value => !!value || "Required.",
        },
        counter: {
          name: "字数限制",
          // eslint-disable-next-line @typescript-eslint/restrict-template-expressions
          fun: (value, max, min) => (value && value.length >= min && value.length <= max) || `Max ${max} Min ${min} characters`,
        },
        phone: {
          name: "手机号",
          fun: value => {
            const pattern = /^\d+$/;
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            return (value && pattern.test(value)) || "Invalid port.";
          },
        },
        ip: {
          name: "ip地址",
          fun: value => {
            const pattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            return (value && pattern.test(value)) || "Invalid IP.";
          },
        },
        url: {
          name: "网址",
          fun: value => {
            const pattern = new RegExp(
              "^(https?:\\/\\/)?" + // protocol
              "((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|" + // domain name and extension
              "((\\d{1,3}\\.){3}\\d{1,3}))" + // OR ip (v4) address
              "(\\:\\d+)?" + // port
              "(\\/[-a-z\\d%_.~+]*)*" + // path
              "(\\?[;&a-z\\d%_.~+=-]*)?" + // query string
              "(\\#[-a-z\\d_]*)?$", "i"); // fragment locator
            return !!pattern.test(value);
          },
        },
        idCard: {
          name: "身份证",
          fun: value => {
            const reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            return reg.test(value);
          },
        },
        email: {
          name: "邮箱",
          fun: value => {
            const pattern = /^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/;
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            return pattern.test(value);
          },
        },
        // eslint-disable-next-line id-blacklist
        number: {
          name: "数字",
          fun: value => {
            const pattern = /^\d+$/;
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            return pattern.test(value);
          },
        },
        acount: {
          name: "数字",
          fun: value => {
            const pattern = /^[a-zA-Z]\w*$/;
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            return pattern.test(value);
          },
        },
      },
      tableHeaderList: [],
      tableSearchInput: null,
      needItemsField: ['v-radio-group', 'v-select', 'v-checkbox'],
      fieldList: [
        { text: "单行文本", icon: "text-short", tag: "v-text-field" },
        { text: "多行文本", icon: "text-long", tag: "v-textarea" },
        { text: "下拉选项", icon: "form-dropdown", tag: "v-select" },
        { text: "单选", icon: "radiobox-marked", tag: "v-radio-group" },
        { text: "多选", icon: "checkbox-marked-outline", tag: "v-checkbox" },
        { text: "数字", icon: "numeric-10-box", tag: "v-text-field" },
        { text: "时间", icon: "clock-time-eight-outline", tag: "v-date-picker" },
        { text: "文件", icon: "file-code", tag: "v-file-input" },
        { text: "图片", icon: "image-outline", tag: "v-file-input" },
        { text: "区间", icon: "tune-variant", tag: "v-range-slider" },
        { text: "比例", icon: "percent-outline", tag: "v-slider" },
        { text: "开关", icon: "toggle-switch-off-outline", tag: "v-switch" },
        { text: "密码", icon: "lock-outline", tag: "v-otp-input" },
        { text: "搜索", icon: "feature-search-outline", tag: "v-autocomplete" },
        { text: "打分", icon: "star-box", tag: "v-rating" },
        { text: "JSON编辑器", icon: "star-box", tag: "jh-json-edit" },
      ],
      tabIndex: 0,
      designfieldConfigList: [],
      viewConfigList: [],
      tableFieldList: [],
      activeViewField: null,
      activeField: null,

      demoSelected: [],
      activeBtnItem: null,
      activeTh: null,
      activeData: null,
      // json数据
      actionContent: null,
      pageContent: null,
      headContentStudio: null,
      priKey: null,
      tableHeaderListKey: "",
      headPlusBtnUid: null,
      tableRowSelect: [],
      cPrimaryColor: null,
      serverSearchModelKey: ["serverSearchWhere", "serverSearchWhereLike"],
      serverSearchType: "v-text-field",
      //===//<$ common.data | variableToVar | safe $>
    }),
    computed: {
      //===//<$ common.computed | methodFormat | safe $>
      serverSearchTypeIndex() {
        if (this.activeField) {
          return this.activeField.value[0].tag === "v-text-field" ? 1 : 0;
        }
        return null;
      },
      tableFieldListForSelect() {
        return this.tableFieldList.map(item => ({ text: `${item.Field}: ${item.Comment}`, value: item.Field }));
      },
      tickEventValue() {
        if (this.activeBtnItem) {
          const eventValue = this.activeBtnItem.attrs['@click'];
          const matchValue = eventValue.match(/doUiAction\('(\w*)'/);
          if (matchValue) {
            return matchValue[1];
          }
          return null;
        }
      },
      tableHiddenHeaderList() {
        let hiddenFieldList = [];
        // table的隐藏字段
        if (this.tabIndex === 1) {
          hiddenFieldList = this.tableFieldList.filter(item => {
            return !this[`${this.tableHeaderListKey}`].some(header => header.value === item.Field);
          });
          if (!this[`${this.tableHeaderListKey}`].some(item => item.value === 'action')) {
            hiddenFieldList.push({ Field: 'action', Comment: '操作', Type: 'varchar(255)', Key: false, Default: null, });
          }
        }
        // 表单的隐藏字段
        if (this.tabIndex > 1 && this.tabIsActionContent) {
          const existFieldList = this.pickerFormField(this.actionContent[this.tabIndex - 2]);
          hiddenFieldList = this.tableFieldList.filter(item => {
            return !existFieldList.includes(item.Field);
          });
        }
        return hiddenFieldList;
      },
      // 当前激活字段的常量数据
      activeFieldConstants() {
        console.log("activeFieldConstants", this.modelKey)
        if (this.modelKey) {
          console.log("activeFieldConstants", this.constantObj)
          return this.constantObj[this.modelKey] || [];
        }
        return [];
      },
      activeFieldLabel() {
        if (this.activeField) {
          const fieldInput = this.activeField.value.find(item => item.tag && item.tag === 'v-text-field' || item.tag === 'v-select');
          return fieldInput.attrs["prefix"];
        }
        return null;
      },
      modelKey() {
        if (this.activeField) {
          const fieldInput = this.activeField.value.find(item => item.attrs && item.attrs["v-model"]);
          return fieldInput.attrs["v-model"].split(".")[1];
        }
        return null;
      },
      // 表单字段数据输入类型
      tagList() {
        return this.fieldList.map(item => item.tag);
      },
      // 是否包含表单
      tabIsActionContent() {
        if (this.tabIndex < 2) {
          return false;
        }
        return JSON.stringify(this.actionContent[this.tabIndex - 2]).includes("v-form");
      },
      // 表单字段的显示状态
      activeFieldShowStatus() {
        let status = false;
        if (this.activeField) {
          status = JSON.stringify(this.actionContent).includes(this.activeField.uid);
        }
        console.log("activeFieldShowStatus", status);
        return status;
      },
    },
    watch: {
      //===//<$ common.watch | methodFormat | safe $>
      tabIndex(value) {
        if (value !== 1) {
          this.rowSelectChange = [];
          this.rowSelectSingleChange = [];
          this.dataTableHasSearchChange = [];
        }
      },
      priKey() {
        this.tableFieldList = this.tableFieldList.map(item => {
          if (item.Field === this.priKey) {
            item.Key = 'PRI';
          } else {
            item.Key = '';
          }
          return item;
        });
      },
      activeTh: {
        deep: true,
        handler(value) {
          console.log("activeTh", value);
          if (!value) {
            return;
          }
          this[`${this.tableHeaderListKey}`] = this[`${this.tableHeaderListKey}`].map(item => {
            if (item.value === value.value) {
              item = value;
              item.class = item.cellClass = value.fixed ? "fixed" : "";
            }
            return item;
          });
          if (value.itemKey) {
            // this[`${this.tableHeaderListKey}`] itemKey 是唯一的
            this[`${this.tableHeaderListKey}`] = this[`${this.tableHeaderListKey}`].map(item => {
              item.itemKey = item.value === value.value;
              return item;
            });
          }
        }
      },
      cPrimaryColor(value) {
        const validColor = this.isValidColor(value);
        if (validColor) {
          document.body.style.setProperty('--cPrimaryColor', value);
        }
      }
    },
    async created() {
      // 获取 body 的计算样式
      var style = getComputedStyle(document.body);
      // 读取 --cPrimaryColor 的值
      this.cPrimaryColor = style.getPropertyValue('--cPrimaryColor').trim();
      console.log("this.workspaceFolders", this.projectPath);
      await this.getPageConfig();
      await this.getDbFieldList();
      //===//<$ common.createdString | createdString | safe $>
    },
    mounted() {
    },
    methods: {
      saveConfig() {
        switch (this.tabIndex) {
          case 0:
            this.saveTableField();
            break;
          case 1:
            this.savePageContent();
            break;
          default:
            this.saveActionContent();
            break;
        }
      },
      // 绑定服务端搜索字段
      onServerSearchFieldBind(event) {
        if (!this.hasOwnProperty(this.serverSearchModelKey[this.serverSearchTypeIndex])) {
          this[this.serverSearchModelKey[this.serverSearchTypeIndex]] = {};
        }
        this[this.serverSearchModelKey[this.serverSearchTypeIndex]][event] = "";
        this.activeField.value[0].attrs['v-model'] = `${this.serverSearchModelKey[this.serverSearchTypeIndex]}.${event}`;
        console.log("onServerSearchFieldBind", this.activeField.value[0].attrs['v-model']);
        const label = this.tableFieldList.find(item => item.Field === event).Comment;
        this.onServerSearchFieldLabelChange(label);
      },
      onServerSearchFieldLabelChange(event) {
        const find = this.activeField.value.find(item => item.tag && item.tag === 'v-text-field' || item.tag === 'v-select');
        find.attrs["prefix"] = event;
      },
      // 绑定服务端搜索字段
      onServerSearchTypeChange(event) {
        // 把字段移动
        this.activeField.value[0].tag = event;
        const inputType = event === 'v-text-field' ? 1 : 0;
        if (!this.hasOwnProperty(this.serverSearchModelKey[inputType])) {
          this[this.serverSearchModelKey[inputType]] = {};
        }
        this[this.serverSearchModelKey[inputType]][this.modelKey] = "";
        delete this[this.serverSearchModelKey[1 - inputType]][this.modelKey];
      },
      // 移除服务端搜索字段
      onServerSearchFieldRemove() {
        const inputType = this.activeField.value[0].tag === 'v-text-field' ? 0 : 1;
        if (this.hasOwnProperty(this.serverSearchModelKey[this.serverSearchTypeIndex])) {
          delete this[this.serverSearchModelKey[this.serverSearchTypeIndex]][this.modelKey];
        }
      },
      // 服务端搜索显隐
      onServerSearch(status) {
        if (status) {
          this.serverSearchFieldRow = serverSearchFieldRow();
          this.serverSearchCol.value.push(this.serverSearchFieldRow);
        } else {
          this.serverSearchCol.value.splice(0, this.serverSearchCol.value.length);
          this[this.serverSearchModelKey[0]] = {};
          this[this.serverSearchModelKey[1]] = {};
        }
      },
      // 返回随机 UID
      getUid() {
        return `tag_id_${Math.random().toString(36).substr(2, 16)}`;
      },
      // 表格属性变动。直接相应到表格的数据
      onRowSelectChange(status) {
        console.log("onRowSelectChange", this.rowSelectChange);
        this.rowSelectChange.forEach(item => {
          item(status);
        });
      },
      // 表格属性变动。直接相应到表格的数据
      onrowSelectSingleChange(status) {
        this.rowSelectSingleChange.forEach(item => {
          item(status);
        });
      },
      // 显示/隐藏表格的搜索
      onDataTableHasSearchChange(status) {
        this.dataTableHasSearchChange.forEach(item => {
          item(status);
        });
      },
      // 显示/隐藏表格的搜索框
      tableSearchInputShowOrHide(status, tableUid) {
        // 备份下搜索到的search对应的 input，然后隐藏
        // 把备份的input显示出来，位置就是表格的上方 v-row 内最后一个
        console.log("tableSearchInputShowOrHide", status, tableUid);
        this.tableDataSearchCol.value = [];
        if (status) {
          this.tableDataSearchCol.value.push(tableSearchInput(this.dataTableHasSearchKey));
        }
        console.log("tableSearchInputShowOrHide", this.tableDataSearchCol, this.pageContent);
      },
      // End 表格属性变动。直接相应到表格的数据
      // col的布局是可拖动的
      isFormCol(value) {
        if (Array.isArray(value)) {
          return value.every(item => {
            return item.tag === 'v-col' && item.value.some(item => this.tagList.includes(item.tag));
          });
        }
        return false;
      },
      // 当表单字段输入类型变动
      onFormFieldTypeChange(event) {
        if (this.needItemsField.includes(event)) {
          this.activeField.value[1].attrs[":items"] = `constantObj.${this.modelKey}`;
        } else {
          delete this.activeField.value[1].attrs[":items"];
        }
      },
      // 数据表操作 start
      addNewTableField() {
        this.tableFieldList.push({
          Field: null,
          Comment: null,
          Type: "varchar(255)",
          Key: false,
          Default: null,
        });
      },

      // 数据表操作 end
      closePropertyContainer() {
        this.activeBtnItem = null;
        this.activeTh = null;
        this.activeData = null;
        this.activeField = null;
      },
      // 字段的隐藏和显示
      fieldShownChange(event) {
        if (this.tabIndex === 1) {
          this.tableFieldShownChange(event);
        } else {
          this.formFieldShownChange(event);
        }
      },
      // 隐藏字段点击事件
      onHiddenFieldTap(item) {
        if (this.tabIndex === 1) {
          this.setActiveTh(item);
        }
        if (this.tabIsActionContent) {
          this.activeField = textFieldCol(item);
          this.formFieldShownChange(true);
        }
      },
      // 表单字段的显隐
      formFieldShownChange(event) {
        const actionContent = this.actionContent[this.tabIndex - 2];
        if (event) {
          // 显示字段
          let formBodyPoint = null;
          const findIsFormUid = (content) => {
            if (typeof content === 'object') {
              const isFormBody = content.value.every(item => {
                return item.tag === 'v-col' && item.value.some(item => this.tagList.includes(item.tag));
              });
              if (isFormBody) {
                formBodyPoint = content;
              } else {
                content.value.find(item => {
                  findIsFormUid(item);
                });
              }
            }
          }
          findIsFormUid(actionContent);
          console.log("formBodyPoint", formBodyPoint);
          formBodyPoint && formBodyPoint.value.push(this.activeField);
        } else {
          this.removeById([actionContent], this.activeField.uid);
        }
      },
      // 表格字段的显隐
      tableFieldShownChange(event) {
        if (event) {
          const needPush = this.tableHiddenHeaderList.find(item => item.Field === this.activeTh.value);
          console.log("needPush", this.tableHiddenHeaderList)
          if (needPush) {
            this[`${this.tableHeaderListKey}`].push(tableItem(needPush));
          }
        } else {
          this[`${this.tableHeaderListKey}`] = this[`${this.tableHeaderListKey}`].filter(item => item.value !== this.activeTh.value);
        }
      },
      // doUiAction
      async doUiAction(uiActionId, uiActionData) {
        console.log("doUiAction", uiActionId, uiActionData);
        if (uiActionId.toLowerCase().includes("delete")) {
          return;
        }
        if (uiActionId.toLowerCase().includes("create")) {
          return;
        }
        if (uiActionId.toLowerCase().includes("update")) {
          return;
        }
        try {
          switch (uiActionId) {
            //===//<$ common.doUiAction | doUiActionFormat | safe $>
            default:
              console.error("[doUiAction] uiActionId not find", { uiActionId });
              break;
          }
        } catch (error) {
          throw error;
        } finally {
          window.jhMask && window.jhMask.hide();
        }
      },
      // 提取表单中的字段
      pickerFormField(item) {
        let fieldList = [];
        if (item.tag && this.tagList.includes(item.tag)) {
          fieldList.push(this.modelKey);
        }
        if (item.value && Array.isArray(item.value)) {
          item.value.forEach(value => {
            fieldList.push(...this.pickerFormField(value));
          });
        }
        return fieldList;
      },
      // 自动计算操作列的宽度
      resetActionWidth() {
        this[`${this.tableHeaderListKey}`].find((item, index) => {
          if (item.value === 'action') {
            let element = document.getElementsByTagName('td')[index];
            console.log(element.children);
            item.width = 0;
            for (let i = 0; i < element.children.length; i++) {
              item.width += element.children[i].offsetWidth;
            }
            console.log("action width", item.width);
            return true;
          }
          return false;
        })
      },
      // 按钮事件流的切换
      activeBtnItemTypeChange(value) {
        const actionType = this.designConstants.doUiAction.find(item => item.value === value);
        if (this.activeBtnItem.tag === 'v-btn') {
          this.activeBtnItem.value[0] = actionType.text;
        } else {
          this.activeBtnItem.value[1] = actionType.text;
        }
        if (this.activeBtnItem.type === 'rowAction') {
          this.activeBtnItem.attrs["@click"] = `doUiAction('${actionType.value}', item)`;
        } else {
          this.activeBtnItem.attrs["@click"] = `doUiAction('${actionType.value}')`;
        }
        if (this.activeBtnItem.type === 'rowAction') {
          // 刷新表格数据
          console.log('this.tableDataKey', this.tableDataKey, this[this.tableDataKey]);
          this[this.tableDataKey] = _.cloneDeep(this[this.tableDataKey]);
        }
        console.log('this.activeBtnItem.attrs["@click"]', this.activeBtnItem.attrs["@click"]);
      },
      // 获取数据库字段列表
      async getDbFieldList() {
        const result = await window.appAxios({
          packageType: "getFieldListRequest",
          data: {
            appData: {
              appId: this.appId,
              webPageId: this.webPageId,
              // pageFile: this.pageFile,
            },
          }
        })
        const { fieldList, error } = result.data.appData;
        this.tableFieldList = fieldList;
        this.priKey = fieldList.find(item => item.Key === 'PRI').Field;
      },
      // 获取页面配置 json
      async getPageConfig() {
        const designFieldConfigList = await window.appAxios({
          packageType: "getFieldConfigRequest",
          data: {
            appData: {
              appId: this.appId,
              webPageId: this.webPageId,
              pageJsonPath: this.jsonPath,
              // pageFile: this.pageFile,
            },
          }
        })
        const { actionContent, pageContent, headContentStudio, error } = designFieldConfigList.data.appData;
        if (error) {
          return;
        }
        this.actionContent = actionContent;
        this.headContentStudio = headContentStudio;
        this.initActionContent();
        this.initPageContent(pageContent);
        this.initHeadContentStudio();
      },
      initHeadContentStudio() {
        // 提取帮助
        this.headContentStudio.forEach(item => {

        })
      },
      // 初始化字段设计
      initActionContent() {
        this.actionContent.map(item => {
          this.tabItems.push({ text: item.value[0].value[0].value[0].value[0], icon: "dock-right" });
        });
      },
      // 初始化页面配置；映射 header 的 data 变量名
      initPageContent(pageContent) {
        const loopFun = (content) => {
          content.forEach((pageItemContent) => {
            if (pageItemContent.tag === 'v-data-table') {
              this.tableHeaderListKey = pageItemContent.attrs[":headers"];
              this[`${this.tableHeaderListKey}`].forEach(item => {
                item.shown = true;
                item.fixed = item.class === 'fixed' || item.cellClass === 'fixed';
              })
            }
            if (pageItemContent.value && Array.isArray(pageItemContent.value) && pageItemContent.value.length) {
              loopFun(pageItemContent.value);
            }
          })
        }
        loopFun(pageContent);
        console.log(pageContent);
        this.pageContent = pageContent;
      },

      // 移除按钮
      removeBtn() {
        if (this.activeBtnItem.type === 'headAction') {
          this.tableHeadRow.value.splice(this.tableHeadRow.value.findIndex(item => item.uid === this.activeBtnItem.uid), 1);
        } else {
          this.removeById(this.pageContent, this.activeBtnItem.uid);
          // 自动设定action宽度
          this.resetActionWidth();
        }
        this.activeBtnItem = null;
      },
      // 列顺序调换
      tdMove(header, arrow) {
        let arr = this[`${this.tableHeaderListKey}`];
        let index = arr.findIndex(item => item.value === header.value);
        if (Math.abs(arrow) === 1) {
          let targetIndex = Math.max(Math.min(index + arrow, arr.length - 1), 0);
          // 位置互换
          [arr[index], arr[targetIndex]] = [arr[targetIndex], arr[index]];
          this.activeTh.index = arr.findIndex(item => item.value === header.value) + 1;
        }
        if (Math.abs(arrow) === 999) {
          arr.splice(index, 1);
          arrow === -999 ? arr.unshift(header) : arr.push(header);
          this.activeTh.index = arr.findIndex(item => item.value === header.value) + 1;
        }
        this[`${this.tableHeaderListKey}`] = _.cloneDeep(arr);
      },
      // 当前按钮颜色变动
      btnColorChange(event) {
        if (this.activeBtnItem.tag === 'v-btn') {
          this.activeBtnItem.attrs.color = event;
          document.querySelector(`[uid=${this.activeBtnItem.uid}]`) && document.querySelector(`[uid=${this.activeBtnItem.uid}]`).classList.add("activeDom");
        } else {
          const regex = /(\w+--text)/g;
          this.activeBtnItem.attrs.class = this.activeBtnItem.attrs.class.replace(regex, event + '--text');
          this.activeBtnItem.value[0].attrs.class = this.activeBtnItem.value[0].attrs.class.replace(regex, event + '--text');
        }
      },
      // 选中列 th
      setActiveTh(field) {
        if (this.tabIndex === 1) {
          let thItem;
          if (field.value && field.text) {
            thItem = field;
          } else {
            thItem = tableItem(field, false);
          }
          this.activeTh = thItem;
          this.activeTh.index = this[`${this.tableHeaderListKey}`].findIndex(item => item.value === thItem.value) + 1;
          this.activeBtnItem = null;
          this.activeData = null;
          this.activeField = null;
        }
        if (this.tabIndex > 1 && this.tabIsActionContent) {
        }
      },
      // 选中单元格 td
      setActiveData(header, item) {
        document.querySelector(`button.activeDom`) && document.querySelector(`button.activeDom`).classList.remove("activeDom");
        if (header.value === 'action') {
          return;
        }
        this.activeTh = null;
        this.activeField = null;
        this.activeBtnItem = null;
        this.activeData = header;
        this.activeData.dataType = 'text';
      },
      // 选中按钮
      setActiveBtn(item, forceUpdate) {
        this.activeTh = null;
        this.activeData = null;
        this.activeBtnItem = item;
        this.activeBtnForceUpdate = forceUpdate;
        this.activeField = null;
        if (this.activeBtnItem.tag === 'v-btn') {
          this.activeBtnItem.color = this.activeBtnItem.attrs.color;
        } else {
          const regex = /(\w+--text)/g;
          const match = this.activeBtnItem.attrs.class.match(regex);
          this.activeBtnItem.color = match && match[0].split("--")[0];
        }
      },
      // 选中表单字段
      setActiveField(domItem) {
        this.activeField = domItem;
        this.activeTh = null;
        this.activeData = null;
        this.activeBtnItem = null;
      },
      // 根据id 移除 json数据
      removeById(obj, idToRemove) {
        if (Array.isArray(obj)) {
          for (let i = 0; i < obj.length; i++) {
            if (obj[i] && typeof obj[i] === 'object') {
              if (obj[i].uid === idToRemove) {
                obj.splice(i, 1);
                i--;  // Decrease index to handle the changed array
              } else {
                this.removeById(obj[i].value, idToRemove);
              }
            }
          }
        }
      },
      // 根据uid插入数据, 暂时无用了，有更好的办法了
      // insertBeforeById(obj, idToFind, newData) {
      //   if (Array.isArray(obj)) {
      //     const find = obj.some(item => {
      //       if (item.uid === idToFind) {
      //         obj.splice(obj.indexOf(item), 0, newData);
      //         return true;
      //       }
      //     })
      //     if (!find) {
      //       obj.forEach(item => {
      //         this.insertBeforeById(item.value, idToFind, newData);
      //       })
      //     }
      //   }
      // },

      // 设计环节页面的切换
      setPageStep(index) {
        this.activeTh = null;
        this.activeBtnItem = null;
        this.activeData = null;
        this.activeField = null;

        this.tabIndex = index;
      },
      onStart() {
      },
      onEnd() {
      },
      // 移除选项
      removeOption(option) {
        if (!this.modelKey) {
          return;
        }
        this.constantObj[this.modelKey] = this.constantObj[this.modelKey].filter(item => typeof option === 'string' ? item !== option : item.text !== option.text);
        this.constantObj = _.cloneDeep(this.constantObj);
      },
      // 添加新的选项
      addNewOption() {
        if (!this.modelKey) {
          return;
        }
        if (!this.constantObj[this.modelKey]) {
          this.constantObj[this.modelKey] = [];
        }
        this.constantObj[this.modelKey].push({ text: "新选项", value: "新选项" });
        this.constantObj = _.cloneDeep(this.constantObj);
      },
      // 保存数据库字段列表
      async saveTableField() {
        // fieldName 不能为空
        // fieldType 不能为空
        const valid = this.tableFieldList.some(item => {
          if (!item.Field) {
            window.vtoast.fail("字段名称不能为空");
            return true;
          }
          if (!item.Type) {
            window.vtoast.fail("字段类型不能为空");
            return true;
          }
        })
        if (valid) {
          return;
        }
        // 发送数据
        if (!(await window.confirmDialog({ title: '保存', content: '确定保存字段吗？' }))) {
          return;
        }
        window.vtoast.loading("正在保存字段信息");
        await window.appAxios({
          packageType: "updateTableField",
          data: {
            appData: {
              pageId: this.pageId,
              appId: this.appId,
              webPageId: this.webPageId,
              // pageFile: this.pageFile,
              webPageName: this.webPageName,
              actionData: {
                fieldList: this.tableFieldList,
              }
            },
          },
          callback: (value) => {
            if (value.appData.isEnd) {
              window.vtoast.success("运行成功");
            }
          }
        })
      },
      // 保存抽屉的设计
      async saveActionContent() {
        window.vtoast.loading("正在保存抽屉配置");
        await window.appAxios({
          packageType: "updatePageContent",
          data: {
            appData: {
              pageId: this.pageId,
              appId: this.appId,
              webPageId: this.webPageId,
              webPageName: this.webPageName,
              actionData: {
                constantObj: this.constantObj,
                actionContent: this.actionContent,
                jsonPath: this.jsonPath,
              }
            },
          },
          callback: (value) => {
            if (value.appData.isEnd) {
              window.vtoast.success("运行成功");
            }
          }
        })
      },
      isValidColor(color) {
        // 十六进制颜色
        const hexRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
        // RGB 颜色
        const rgbRegex = /^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/;
        // RGBA 颜色
        const rgbaRegex = /^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(0|1|0\.\d{1,2})\)$/;
        // CSS 预定义颜色名称
        const cssColorNames = ["red", "blue", "green", "yellow", "black", "white", "purple", "cyan", "magenta", "lime", "pink", "teal", "lavender", "brown", "beige", "maroon", "navy", "olive", "silver", "turquoise"];
        return hexRegex.test(color) || rgbRegex.test(color) || rgbaRegex.test(color) || cssColorNames.includes(color.toLowerCase());
      },
      // 保存页面的配置
      async savePageContent() {
        // 验证数据
        const validColor = this.isValidColor(this.cPrimaryColor);
        if (!validColor) {
          window.vtoast.fail("主题色不合法");
          return;
        }
        // 1. 要把 header 重新覆盖下
        const newHeader = this[this.tableHeaderListKey];
        // 2. 要把 pageContent 重新覆盖下，排除掉 uid
        // 3. 要最最新的 json。通过命令生成到页面中
        // parse data
        const pageContent = _.cloneDeep(this.pageContent);
        this.removeById(pageContent, this.headPlusBtnUid);
        window.vtoast.loading("正在保存页面配置");
        await window.appAxios({
          packageType: "updatePageContent",
          data: {
            appData: {
              pageId: this.pageId,
              appId: this.appId,
              webPageId: this.webPageId,
              webPageName: this.webPageName,
              actionData: {
                header: newHeader,
                headerKey: this.tableHeaderListKey,
                pageContent,
                headContentStudio: this.headContentStudio,
                jsonPath: this.jsonPath,
                hasHelpDrawer: this.hasHelpDrawer,
                cPrimaryColor: this.cPrimaryColor,
                rootPath: `${this.projectPath}/`
              }
            },
          },
          callback: (value) => {
            if (value.appData.isEnd) {
              window.vtoast.success("运行成功");
            }
          }
        })

      },

      //===//<$ common.methods | methodFormat | safe $>
    }
  })
</script>

<style scoped>
  body {
    padding: 0 !important;
  }

  .jh-page-body-container>.v-card {
    min-height: calc(100vh - 64px - 56px) !important;
  }

  .v-input .v-label {
    line-height: 1.45;
  }

  .designContainerCardLeft {
    flex: 1;
  }

  .designContainerCardLeft>* {
    height: 100% !important;
  }

  .designContainerCard {
    max-width: 300px;
    min-width: 300px;
    margin-left: 20px;
  }

  .designContainer {
    max-width: 200px;
    min-width: 200px;
    border-right: 1px solid #EEEEEE;
    border-radius: 0 !important;
  }

  .designContainer.right {
    border-left: 1px solid #EEEEEE;
    border-right: 0 !important;
    padding-left: 12px;
  }

  .v-bottom-navigation .v-btn.v-btn--active {
    background-color: #e0ffe9;
  }

  .v-bottom-navigation {
    box-shadow: 0 1px 20px 0 rgb(0 0 0 / 2%) !important;
  }

  .designItemBoxDraggable>span {
    display: flex;
    flex-wrap: wrap;
  }

  body .activeDom {
    box-sizing: border-box;
    /* border: 1px dashed #333333; */
    position: relative;
  }

  body .activeDom::after {
    box-sizing: border-box;
    border: 1px dashed #333333;
    content: "";
    position: absolute;
    display: block;
    left: 1px;
    top: 1px;
    right: 1px;
    bottom: 1px;
  }

  span[role="button"] {
    white-space: nowrap;
  }

  .designItemBox .chosen {
    border: 1px dotted #333333;
    cursor: move;
  }

  .designItemBox .col-12:hover {
    border: 1px dotted #333333;
    cursor: move;
  }

  .designItemBox .col-12 .v-icon.mdi-close:hover {
    color: red;
  }

  .designItemBox .col-12 {
    border-radius: 8px;
    border: 1px dotted #FFFFFF;
  }

  .designItemBox .col-12.active {
    border: 1px dotted #333333;
    background-color: #fbfbfb;
  }

  .rulesBox .theme--light.v-btn-toggle .v-btn.v-btn--active {}

  .rulesBox .theme--light.v-btn-toggle .v-btn {
    border-radius: 4px !important;
    border: 1px solid #EEEEEE !important;
    margin-bottom: 3px !important;
    margin-right: 2px !important;
    max-height: 24px !important;
    font-size: 12px;
  }

  .rulesBox .v-btn-toggle {
    display: flex !important;
    flex-wrap: wrap;
  }

  .tableTabsBox .v-tab {
    padding: 0 !important;
  }

  .tableTabsBox .v-slide-group__prev,
  .tableTabsBox .v-slide-group__next {
    display: none !important;
  }

  .v-application .activeBtnItem {
    border: 1px dashed #333333 !important;
    background-color: transparent !important;
  }

  .v-data-table>.v-data-table__wrapper>table>tbody>tr>td.editing,
  .v-data-table--fixed-header>.v-data-table__wrapper>table>thead>tr>th.editing {
    border: 1px dashed #333333 !important;
  }

  .v-data-table>.v-data-table__wrapper>table>tbody>tr>td.isActionTd {
    white-space: nowrap !important;
  }

  .viewLeftListItem.v-list-item {
    position: relative;
    overflow: hidden;
    border: 1px solid #CCCCCC;
    border-radius: 5px;
    margin-bottom: 5px;
    margin-right: 10px;
    min-height: 35px !important;
  }

  .v-list-item.shown::after {
    content: "";
    background-color: #007220 !important;
    position: absolute;
    transform: rotate(45deg);
    top: -30px;
    right: -40px;
    width: 50px;
    height: 50px;
  }

  /* customStyle >>>>>> */

  /* <<<<<< customStyle */
</style>{% endblock %}